1. frontend í´ë”ì—ì„œ npm run build (Vue.js) ë¥¼ dist ë°°í¬

2. frontend/dist í´ë”ë¥¼ backend ì˜ static ìœ¼ë¡œ ë³µì‚¬

3. main.py ì½”ë“œ ìˆ˜ì • 

# ì‹¤í–‰íŒŒì¼(.exe) ë‚´ë¶€ì˜ ê²½ë¡œ ê°ì§€ (PyInstaller íŒ¨í‚¤ì§•ëœ ê²½ìš° `sys._MEIPASS` ì‚¬ìš©)
if getattr(sys, 'frozen', False):
    BASE_DIR = sys._MEIPASS  # PyInstaller ì‹¤í–‰íŒŒì¼ ë‚´ë¶€ ì••ì¶• í•´ì œ ê²½ë¡œ
else:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))  # ê°œë°œ í™˜ê²½ì—ì„œ ì‹¤í–‰

# ë‚´ë¶€ í´ë” ê²½ë¡œ ì„¤ì •
STATIC_DIR = os.path.join(BASE_DIR, "static")
ROUTES_DIR = os.path.join(BASE_DIR, "routes")
SETTING_DIR = os.path.join(BASE_DIR, "setting")

app.add_middleware(SessionMiddleware, secret_key="nteksystem2025_sv500")
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # âœ… Vue.js ê°œë°œ ì„œë²„ ì£¼ì†Œ (Vite ê¸°ë³¸ í¬íŠ¸)
    allow_credentials=True,  # âœ… ì¿ í‚¤ë¥¼ í—ˆìš©í•´ì•¼ ì„¸ì…˜ì´ ìœ ì§€ë¨!
    allow_methods=["*"],  # ëª¨ë“  HTTP ë©”ì„œë“œ í—ˆìš©
    allow_headers=["*"],  # ëª¨ë“  HTTP í—¤ë” í—ˆìš©
)

# ë””ë²„ê¹…: ì‹¤í–‰íŒŒì¼ ë‚´ë¶€ì—ì„œ static í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
print(f" BASE_DIR: {BASE_DIR}")
print(f" STATIC_DIR: {STATIC_DIR}")

if not os.path.exists(STATIC_DIR):
    print(f"âš  Warning: Static directory '{STATIC_DIR}' does not exist.")
else:
    print(f"Static directory found: {STATIC_DIR}")
    print(f"Static folder contents: {os.listdir(STATIC_DIR)}")

# FastAPIì—ì„œ static í´ë” ì„œë¹™
app.mount("/static", StaticFiles(directory=STATIC_DIR, html=True), name="static")

@app.get("/")
async def root():
    index_path = os.path.join(STATIC_DIR, "index.html")
    print(f"Serving index.html from: {index_path}")  # ë””ë²„ê¹… ë¡œê·¸
    return FileResponse(index_path)


# âœ… Vue Router history ëª¨ë“œ ì§€ì› (API ì œì™¸ ëª¨ë“  ìš”ì²­ì„ `index.html`ë¡œ ë¦¬ë””ë ‰ì…˜)
@app.get("/{path:path}")
async def catch_all(path: str):
    print(f" ìš”ì²­ëœ ê²½ë¡œ: {path}")

    # âœ… `/api/...` ìš”ì²­ì€ FastAPIì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ë„ë¡ ì˜ˆì™¸ ì²˜ë¦¬
    print(f" Vue Router ìš”ì²­: {path}")
    if path.startswith("api/"):
        pass

    # static_file_path = dist_dir / path

    # # âœ… ì •ì  íŒŒì¼ ìš”ì²­(`/assets/...`)ì€ ê·¸ëŒ€ë¡œ ì œê³µ
    # if static_file_path.exists() and static_file_path.is_file():
        # return FileResponse(str(static_file_path))

    # âœ… Vue Router history ëª¨ë“œ ì§€ì› â†’ ëª¨ë“  ê²½ë¡œë¥¼ `index.html`ë¡œ ë¦¬ë””ë ‰ì…˜
    #print(f"ğŸ“‚ Vue Router ìš”ì²­: {path} â†’ {index_file}")
    return FileResponse("static/index.html")

def run_server():
    """FastAPI ì„œë²„ë¥¼ ì‹¤í–‰í•˜ëŠ” í•¨ìˆ˜"""
    uvicorn.run(app, host="127.0.0.1", port=4000)

if __name__ == "__main__":
    # FastAPI ì„œë²„ë¥¼ ë³„ë„ì˜ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰
    server_thread = threading.Thread(target=run_server, daemon=True)
    server_thread.start()

    def shutdown_server():
        print("Shutting down FastAPI server...")
        pid = os.getpid()
        if sys.platform == "win32":
            os.system(f"taskkill /PID {pid} /F")  # Windows ê°•ì œ ì¢…ë£Œ
        else:
            os.kill(pid, signal.SIGKILL)  # Linux, Mac ê°•ì œ ì¢…ë£Œ

    # í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ shutdown_server() ì‹¤í–‰
    atexit.register(shutdown_server)

    try:
        while True:
            pass  # í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
    except KeyboardInterrupt:
        shutdown_server()
	
5. ê° ë¼ìš°í„°ì—ì„œ ì„¤ì •íŒŒì¼ ì°¸ì¡° ì‹œ, ê²½ë¡œ ìˆ˜ì •

# ì‹¤í–‰íŒŒì¼(.exe) ë‚´ë¶€ì˜ ê²½ë¡œ ê°ì§€ (PyInstaller íŒ¨í‚¤ì§•ëœ ê²½ìš° `sys._MEIPASS` ì‚¬ìš©)
if getattr(sys, 'frozen', False):
    BASE_DIR = sys._MEIPASS  # PyInstaller ì‹¤í–‰íŒŒì¼ ë‚´ë¶€ ì••ì¶• í•´ì œ ê²½ë¡œ
else:
    BASE_DIR = os.path.dirname(os.path.abspath(__file__))  # ê°œë°œ í™˜ê²½ì—ì„œ ì‹¤í–‰

os.makedirs("upload", exist_ok=True)  # í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
UPLOAD_DIR = os.path.join(BASE_DIR, "upload")
SETTING_DIR = os.path.join(BASE_DIR, "setting")

def getPath(filename):
    read_path = os.path.join(SETTING_DIR, filename)
    return read_path
    

6. PyInstaller ì„¤ì¹˜ í›„ ë¹Œë“œí•˜ì—¬ í•˜ë‚˜ì˜ ì‹¤í–‰íŒŒì¼ë¡œ ë§Œë“¬
pyinstaller --onefile --add-data "static;static" --add-data "routes;routes" --add-data "setting;setting" --add-data "upload;upload" --hidden-import=uvicorn --hidden-import=fastapi --hidden-import=bcrypt --hidden-import=influxdb_client --name fastapi_server main_fast.py

pyinstaller --onefile --add-data "config.py;." --add-data "static;static" --add-data "routes;routes" --add-data "setting;setting" --add-data "upload;upload" --hidden-import=uvicorn --hidden-import=fastapi --hidden-import=bcrypt --hidden-import=influxdb_client --name fastapi_server main_fast.py


7. npm ìœ¼ë¡œ Electron ì„¤ì¹˜ í›„, electron í´ë” ë§Œë“ ë‹¤ ë‹¤ìŒ ì‹¤í–‰
npm install electron --save-dev
npm init

8.electron ë””ë ‰í† ë¦¬ ê²½ë¡œì—ì„œ main.js ì‘ì„±

const { app, BrowserWindow } = require("electron");
const path = require("path");
const { exec, execSync, spawn } = require("child_process");
const axios = require("axios");

let mainWindow;
let backendProcess;

// âœ… FastAPI ì„œë²„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
const isFastAPIRunning = () => {
    try {
        const result = execSync('tasklist').toString();
        return result.includes("fastapi_server.exe"); // í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸
    } catch (error) {
        return false;
    }
};

// âœ… FastAPI ì„œë²„ ì‘ë‹µ ì—¬ë¶€ í™•ì¸
const checkFastAPIServer = async () => {
    try {
        await axios.get("http://127.0.0.1:4000");
        return true;
    } catch (error) {
        return false;
    }
};

// âœ… FastAPI ì„œë²„ê°€ ì™„ì „íˆ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸°
const waitForFastAPI = async () => {
    let retries = 10;
    while (retries > 0) {
        if (await checkFastAPIServer()) {
            return true;
        }
        console.log(" Waiting for FastAPI server to start...");
        await new Promise((resolve) => setTimeout(resolve, 1000));
        retries--;
    }
    return false;
};

// âœ… FastAPI ì„œë²„ ì‹¤í–‰ í•¨ìˆ˜
const startFastAPIServer = () => {
    const fastAPIPath = path.join(__dirname, "../dist/fastapi_server.exe");
    console.log(` Starting FastAPI Server: ${fastAPIPath}`);

    // FastAPI ì‹¤í–‰ (spawn ì‚¬ìš©í•˜ì—¬ ë…ë¦½ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰)
    backendProcess = spawn(fastAPIPath, [], {
      detached: false,  // Electron ì¢…ë£Œ ì‹œ FastAPIë„ í•¨ê»˜ ì¢…ë£Œë˜ë„ë¡ ì„¤ì •
      stdio: "ignore",  // ì½˜ì†” ì¶œë ¥ ìˆ¨ê¸°ê¸°
      windowsHide: true // âœ… Windowsì—ì„œ í„°ë¯¸ë„ ì°½ì´ ëœ¨ì§€ ì•Šë„ë¡ ì„¤ì •
  });
    //backendProcess = spawn(fastAPIPath, [], { detached: true, stdio: "ignore" });
    //backendProcess.unref();  // Electronì´ ì¢…ë£Œë  ë•Œ ìë™ìœ¼ë¡œ ì¢…ë£Œë˜ì§€ ì•Šë„ë¡ ì„¤ì •
};

// âœ… FastAPI ì„œë²„ ì¢…ë£Œ í•¨ìˆ˜ (taskkill ì‹¤í–‰ ì „ ì²´í¬ ì¶”ê°€)
const stopFastAPIServer = () => {
  if (isFastAPIRunning()) {
      console.log(" Stopping FastAPI Server...");

      try {
          // Windowsì—ì„œëŠ” `taskkill`ì„ ì‚¬ìš©í•˜ì—¬ ê°•ì œ ì¢…ë£Œ
          if (process.platform === "win32") {
              execSync("taskkill /IM fastapi_server.exe /F", { stdio: "ignore" });
              console.log(" FastAPI Server stopped.");
          } else {
              backendProcess.kill();  // ì¼ë°˜ì ì¸ ì¢…ë£Œ (MacOS, Linux)
          }
      } catch (error) {
          console.error(` Error stopping FastAPI: ${error.message}`);
      }
  } else {
      console.log("FastAPI is not running. No need to stop.");
  }
};

// âœ… Electron ì•± ì‹œì‘
app.whenReady().then(async () => {
    console.log("ğŸš€ Starting Electron App...");

    // FastAPI ì„œë²„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸ í›„ ì‹œì‘
    if (!isFastAPIRunning()) {
        console.log(" FastAPI is not running. Starting the server...");
        startFastAPIServer();
    } else {
        console.log(" FastAPI server is already running. Skipping execution.");
    }

    // FastAPIê°€ ì™„ì „íˆ ì‹¤í–‰ë  ë•Œê¹Œì§€ ëŒ€ê¸°
    const fastAPIReady = await waitForFastAPI();

    if (!fastAPIReady) {
        console.error(" FastAPI server did not start. Exiting Electron...");
        app.quit();
        return;
    }

    console.log(" FastAPI server is running! Opening Electron window.");
    createWindow();
});

// âœ… Electron ì°½ ìƒì„±
function createWindow() {
    mainWindow = new BrowserWindow({
        width: 1200,
        height: 800,
        webPreferences: {
            nodeIntegration: true,
        },
    });

    mainWindow.loadURL("http://127.0.0.1:4000");

    mainWindow.on("closed", () => {
        mainWindow = null;
        stopFastAPIServer(); // ì°½ ë‹«í ë•Œ FastAPI ì¢…ë£Œ
    });
}

// âœ… Electron ì•± ì¢…ë£Œ ì‹œ FastAPI ì„œë²„ë„ ì¢…ë£Œ
app.on("window-all-closed", () => {
    if (process.platform !== "darwin") {
        stopFastAPIServer();
        app.quit();
    }
});

// âœ… MacOSì—ì„œ ì°½ì„ ë‹«ì•˜ì„ ë•Œ FastAPIê°€ ë‚¨ì•„ìˆì§€ ì•Šë„ë¡ ì²˜ë¦¬
app.on("before-quit", () => {
    stopFastAPIServer();
});


9. package.json ì— ë‹¤ìŒí•­ëª© ì¶”ê°€

  "scripts": {
    "start": "electron .",
    "build": "electron-builder"
  },
  "build": {
    "appId": "com.nteksystem.SV500Configurator",
    "productName": "SV500Configurator",
    "win": {
      "target": "portable",
      "icon": "configicon.ico",
      "signAndEditExecutable": false,
      "sign": false  
    },
    "files": [
      "**/*",
      "!node_modules/electron", 
      "!node_modules/.bin",
      "!dist",
      "!*.map",
      {
        "from": "../dist/fastapi_server.exe",
        "to": "resources/fastapi_server.exe"
      }
    ],
    "directories": {
      "output": "dist"
    }
  },
10. electron-builder.json íŒŒì¼ ìƒì„±

{
  "win": {
    "target": ["portable"]
  }
}


11. ë¹Œë“œ : npx electron-builder --win portable --publish never --config electron-builder.json

12. fastapi_server.exe íŒŒì¼ì„ electron/dist í´ë”ì— ë³µì‚¬